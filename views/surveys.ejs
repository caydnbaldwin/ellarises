<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Surveys</title>
</head>
<body>


    <!-- For backend: things needed to be passed in: level of the logged in user as "level"
     (they have to be logged in to access this page), all event names as eventnames.eventname, 
     all event types as eventtypes.eventtype, and all surveys inner joined to persons table and events
     and event instances as "surveys". when the search bars are run, those will need to be passed into
     the where statement of the query as "surveys" to display the correct rows 
    -->

    <%- include('components/navbar') %>
    <h1 style="text-align: center;">Surveys</h1><br>

    <% if (surveys.length === 0) { %>
        <div class="alert alert-warning" role="alert">
            No surveys found in the database.
        </div>

    <% } else { %>
        <%- include('components/surveys-email') %>
        <%- include('components/surveys-eventname') %>
        <%- include('components/surveys-eventtype') %>
            

        <div class="table-container">
            <table class="table table-striped">
                <thead>
                    <tr>
                        <th>Person ID</th>
                        <th>First Name</th>
                        <th>Last Name</th>
                        <th>Event Name</th>
                        <th>Event Date</th>
                        <th>Satisfaction Score</th>
                        <th>Usefulness Score</th>
                        <th>Instructor Score</th>
                        <th>Recommendation Score</th>
                        <th>Overall Score</th>
                        <% if (level === "M") {%>
                            <th></th>                            
                            <th></th>
                        <%}%>
                    </tr>
                </thead>
                <tbody>
                    <% for (survey of surveys) { %>
                        <tr>
                            <td><%= survey.personid %></td>
                            <td><%= survey.firstname %></td>
                            <td><%= survey.lastname %></td>
                            <td><%= survey.eventname %></td>
                            <td><%= survey.eventstart %></td>
                            <td><%= survey.surveysatisfactionscore %></td>
                            <td><%= survey.surveyusefulnessscore %></td>
                            <td><%= survey.surveyinstructorscore %></td>
                            <td><%= survey.surveyrecommendationscore %></td>
                            <td><%= survey.surveyoverallscore %></td>
                            <% if (level === "M") {%>
                                <td>
                                    <form action="/surveys/<%= survey.personid%>/<%= survey.eventstart%>/<%= survey.eventid%>" method="GET">
                                        <input type="submit" name="edit" value="edit" />
                                    </form> 
                                </td>
                                <td>
                                    <button onclick="deleteSurvey('<%= survey.personid %>', '<%= survey.eventstart %>', '<%= survey.eventid %>')">
                                        Delete
                                    </button>
                                </td> 
                            <%}%>
                        </tr>
                    <% } %>
                </tbody>
            </table>
        </div>
    <% } %>



    <% if (level === "M") {%>
        <%- include('components/surveys-addsurvey') %>
    <%}%>


<script>
    async function deleteSurvey(personId, eventStart, eventId) {        

        // 2. Ask for confirmation BEFORE deleting
        if (!confirm('Are you sure you want to delete this survey?')) {
            return; 
        }

        try {
            // 3. Use the passed parameters to build the URL
            const response = await fetch(`/survey/${personId}/${eventStart}/${eventId}`, {
                method: 'DELETE',
                headers: { 'Content-Type': 'application/json' }
            });

            if (!response.ok) {
                throw new Error('Failed to delete record.');
            }
            
            // Optional: Reload page or remove element from DOM upon success
            window.location.reload(); 

        } catch (error) {
            console.error(error);
            alert(error.message);
        }
    };
</script>
</body>
</html>