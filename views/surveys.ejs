<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Surveys</title>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.8/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-sRIl4kxILFvY47J16cr9ZwB07vP4J8+LH7qKQnuqkuIAvNWLzeN8tE5YBujZqJLB" crossorigin="anonymous">
  <style>
    html, body { height: 100%; }
    body { overflow: hidden; }
    /* Keep table header visible while scrolling inside card */
    .surveys-table thead th { position: sticky; top: 0; z-index: 2; background-color: var(--bs-body-bg); }
  </style>
</head>

<body>


  <!-- 
    For backend: things needed to be passed in: level of the logged in user as "level"
    (they have to be logged in to access this page), all event names as eventnames.eventname, 
    all event types as eventtypes.eventtype, and all surveys inner joined to persons table and events
    and event instances as "surveys". when the search bars are run, those will need to be passed into
    the where statement of the query as "surveys" to display the correct rows 
  -->

  <%- include('components/navbar') %>
  <main class="container-fluid vh-100 d-flex flex-column">
    <div class="py-3">
      <div class="d-flex align-items-baseline justify-content-between gap-3 mb-2">
        <h1 class="h3 m-0">Surveys</h1>
        <% if (surveys && surveys.length) { %>
          <div class="text-secondary fs-6"><%= surveys.length %> records</div>
        <% } %>
      </div>
    </div>

    <% if (surveys.length===0) { %>
      <div class="flex-grow-1 d-flex align-items-center justify-content-center px-3">
        <div class="alert alert-warning m-0" role="alert">
          No surveys found in the database.
        </div>
      </div>
    <% } else { %>
      <div class="card flex-grow-1 d-flex flex-column h-50 overflow-auto">
        <div class="card-header">
          <div class="d-flex align-items-center justify-content-between">
            <div class="d-flex align-items-baseline gap-2">
              <span class="fw-semibold">Survey Records</span>
              <% if (surveys && surveys.length) { %>
                <span class="badge text-bg-secondary"><%= surveys.length %></span>
              <% } %>
            </div>
          </div>
        <% if (person.role ==="admin" ) {%>
            <!-- <%// include('components/surveys-addsurvey') %> -->
            <div class="text-end">
                <a href="/surveys/surveys" class="btn btn-primary">Clear</a>
                <a href="/surveys/addsurvey" class="btn btn-primary">Add Survey</a>
            </div>
        <%}%>
          <div class="mt-2">
            <div class="row g-2">
              <div class="col-12 col-lg-4">
                <%- include('components/surveys-email') %>
              </div>
              <div class="col-12 col-lg-4">
                <%- include('components/surveys-eventname') %>
              </div>
              <div class="col-12 col-lg-4">
                <%- include('components/surveys-eventtype') %>
              </div>
            </div>
          </div>
        </div>
        <!-- <div class="card-body p-0 overflow-auto d-flex justify-content-center"> -->
        <div class="card-body p-0 overflow-auto">
          <div class="table-responsive">
            <br><%- include('components/surveys-table') %>
          </div>
        </div>
      </div>
    <% } %>
  </main>
  <script>
    async function deleteSurvey(personId, eventStart, eventId) {
      if (!confirm('Are you sure you want to delete this survey?')) {
        return;
      }
      try {
        const response = await fetch(`/surveys/${personId}/${eventStart}/${eventId}`, {
          method: 'DELETE'
        });
        if (response.ok) {
          throw new Error('Failed to delete record.');
        };
        window.location.reload();
      } catch (error) {
        console.error(error);
        alert(error.message);
      }
    };
  </script>
</body>

</html>