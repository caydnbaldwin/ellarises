<% 
  function getMilestoneType(title) {
    if (!title) return "Other";
    const t = String(title).toUpperCase();
    if (
      t.includes("DIPLOMA") ||
      t.startsWith("BS") ||
      t.startsWith("BA") ||
      t.startsWith("MS") ||
      t.includes("MBA") ||
      t.includes("MFA") ||
      t.startsWith("AA") ||
      t.startsWith("AS") ||
      t.includes("PHD")
    ) {
      return "Diploma";
    }
    if (t.includes("PROJECT")) {
      return "Project";
    }
    return "Other";
  }
%>
<table class="table table-striped table-hover milestones-table w-auto mx-auto">
  <thead class="table">
    <tr>
      <th scope="col">First Name</th>
      <th scope="col">Last Name</th>
      <th scope="col">Milestone Number</th>
      <th scope="col">Milestone Title</th>
      <th scope="col">Milestone Type</th>
      <th scope="col">Milestone Date</th>
      <% if (person.role ==="admin" ) {%>
        <th scope="col" style="width:90px;">Delete</th>
        <th scope="col" style="width:90px;">Edit</th>
      <%}%>
    </tr>
  </thead>
  <tbody>
    <% for (milestone of milestones) { %>
      <tr>
        <td scope="row">
          <%= milestone.firstname %>
        </td>
        <td scope="row">
          <%= milestone.lastname %>
        </td>
        <td scope="row">
          <%= milestone.milestonenumber %>
        </td>
        <td scope="row">
          <%= milestone.milestonetitle %>
        </td>
        <% const milestonetype = getMilestoneType(milestone.milestonetitle); %>
        <td scope="row">
            <% if (milestonetype === "Diploma") { %>
                Diploma
            <% } else if (milestonetype === "Project") { %>
                Project
            <% } else { %>
                Other
            <% } %>
        </td>
        <td scope="row">
          <%= new Date(milestone.milestonedate).toLocaleDateString() %>
        </td>
        <% if (person.role ==="admin" ) {%>
          <td scope="row" class="action-cell">
            <form action="/milestones/edit/<%= milestone.personid%>/<%= milestone.milestonenumber%>" method="GET">
              <input type="submit" name="edit" value="edit" />
            </form>
          </td>
          <td scope="row" class="action-cell">
            <button onclick="deleteMilestone('<%= milestone.personid %>', '<%= milestone.milestonenumber %>')">Delete</button>
          </td>
          
        <%}%>
      </tr>
    <% } %>
  </tbody>
</table>

<script>
  async function deleteMilestone(personid, milestonenumber) {
    if (!confirm('Are you sure you want to delete this milestone?')) {
      return;
    }
    try {
      const response = await fetch(`/milestones/delete/${personid}/${milestonenumber}`, {
        method: 'DELETE'
      });
      if (response.ok) {
        throw new Error('Failed to delete milestone.');
      };
      window.location.reload();
    } catch (error) {
      console.error(error);
      alert(error.message);
    }
  };
</script>